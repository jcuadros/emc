---
output:
  revealjs::revealjs_presentation:
    theme: simple
    slide_level: 2
    highlight: pygments
    center: false
    self_contained: true
    css: "../css/styles.css"
    reveal_options:
      slideNumber: true
      previewLinks: false
      transition: 0
      background_transition: 0
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
##

<img src="../images/IQSlogo.png" style="border-style:none;box-shadow:none;
position:absolute;margin:0;top:20px;left:20px;max-width:200px;height:auto;" />

<div style="font-size:1.5em;font-weight:700;margin-top:200px;">Control estadístico de procesos</div>
<div style="font-size:1.4em;font-weight:500;color:#333333;">Introducción a R</div>
<div style="font-size:1.2em;margin-top:40px;color:#333333;">Jordi Cuadros, Lucinio González</div>
<div style="margin-top:80px;color:#333333;">Diciembre de 2017</div>


# Elementos básicos de R

## R

R es un entorno y un lenguaje de programación estadística.

Es una de las herramientas más usadas en el análisis de datos. Es de código libre, su uso es gratuito y dispone de una comunidad muy activa que contribuye al desarrollo de herramientas y funciones adicionales (más de 10.000 paquetes) y a la resolución de preguntas a través de la red.

https://www.r-project.org/about.html
https://www.rdocumentation.org/
https://stackoverflow.com/questions/tagged/r 


## Instalación de R y RStudio

- **R**

    Se puede instalar desde https://cran.r-project.org/.


- **RStudio**
  
    Es una interfaz gráfica (o IDE) para la realización de cálculos y la programación en R.
  
    Se instala desde https://www.rstudio.com/, versión RStudio Desktop (Open Source License).

## R como herramienta de cálculo
**R** puede usarse desde la consola introduciendo directamente las instrucciones correspondientes.

```{r, echo = TRUE}
2 + 3 
8 ^ 10
log(100) # Logaritmo neperiano
``` 
\# indica que lo que sigue es un comentario

## Uso de *scripts*
Un *script* en R es un conjunto de instrucciones escritas en un archivo de texto, de forma que estás puedan almacenarse y ejecutarse con posterioridad. Se suelen almacenar con la extensión `.R`.

Un editor muy recomendado para la creación, ejecución y depuración de estos *scripts* es **RStudio**.

## Acceso a la ayuda
- Buscar ayuda sobre una función
```{r, echo = TRUE, eval = FALSE}
? "mean"
```
- Buscar un texto en la ayuda
```{r, echo = TRUE, eval = FALSE}
?? "anova"
```

En RStudio, se puede seleccionar y pulsar F1 para buscar en la ayuda

## Datos básicos
- *numeric*: número decimal de 15 dígitos significativos
- *integer*
- *logical*
- *character*

## Datos básicos -- *numeric*
```{r, echo = TRUE}
a <- 2
a
class(a)
```
---- 
```{r, echo = TRUE}
b <- 13.6788956789
b
class(b)
print(b, digits = 10)
```
----
```{r, echo = TRUE}
a+b
a-b
a*b
```
----
```{r, echo = TRUE}
a^b
a/b

```
## Datos básicos -- *integer*
Permite almacenar números enteros. Es el tipo de datos usado para contadores e
índices.

```{r, echo = TRUE}
n <- as.integer(340000)
class(n)
n <- 2L
class(n)
```

## Datos básicos -- *character*
Permite almacenar cadenas de texto de longitud indeterminada.

Los literales se indican entre comillas dobles (o simples).

```{r, echo = TRUE}
a <- "aaa"
b <- "bbb"

paste(a, b, "hola", sep = ", ") 
```

## Datos básicos -- *logical*
Almacena valores que son verdadero (`r T`) o falso (`r F`).

Es el resultado de una comparación.

```{r, echo = TRUE}
3 == 2
b <- 3 != 2 
b
```

----

Las operaciones fundamentales entre valores lógicos son

```{r, echo = TRUE}
a <- TRUE
b <- F
a & b # Operador AND
a | b # Operador OR
!b  # Operador NOT
``` 

## Conversión a datos básicos
Las funciones de conversión de tipos en R se indican como `as.` seguido del tipo de dato de destino.

```{r, echo = TRUE}
as.character(2)
as.numeric(TRUE)
```

Para saber si una información o variable es de un tipo determinado puede usarse `is.` seguido del tipo de dato a comprobar.

## Constantes
R incorpora algunas constantes preestablecidas como
```{r, echo = TRUE}
pi
```

```{r, echo = TRUE, eval = FALSE}
Inf
NaN
NA
NULL
```

----

También existen funciones para evaluar si un dato corresponde a una de estas constantes.

```{r, echo = TRUE}
is.na(3)
is.null(NULL)
is.infinite(-Inf)
```

## Datos compuestos
- **Principales**
    - Vector
    - Factor
    - *Data frame* (Tabla de datos)
- Otros tipos comunes
    - Factor ordenado
    - Lista
    - Matriz

## Datos compuestos -- vector
```{r, echo = TRUE}
a <- c(2, 3, 4)
str(a)
a[2]
```

----

Las operaciones se aplican a vectores y devuelven vectores
```{r, echo = TRUE}
a + a 
a > 2.5
```

----

Atención al reciclaje de datos...
```{r, echo = TRUE}
a <- c(2, 3, 4)
b <- c(10, 20)
a * b
```

----

Las funciones en R suelen ser vectoriales

- algunas devuelven vectores
```{r, echo = TRUE}
a <- c(2, 3, 4)
abs(sin(a))
exp(a)
```

----

- otras devuelven valores agregados
```{r, echo = TRUE}
length(a)
sum(a)
mean(a)
```

También `sd`, `max`, `min`...

----

Puede determinarse si un valor está presente en un vector con el operador `%in%`.
```{r, echo = TRUE}
a <- c(2, 3, 4)
3 %in% a
c(2,5,3,4) %in% a
```

----

Existen estructuras especificas para crear vectores secuencia.
```{r, echo = TRUE}
1:10
seq(1, 10, by = 2)
seq(1, 3, length.out = 5) 
```

----

Los vectores se ordenan usando las funciones `sort` y `order`.
```{r, echo = TRUE}
a <- c(8, 2, 5, 3)
sort(a)
a[order(a)]
a[order(a,decreasing = T)]
```

##  Datos compuestos -- factor
Un factor es un vector de cadenas indexado. Normalmente se crea a partir del vector de cadenas de texto.

```{r, echo = TRUE}
a <- c("hola", "adeu","hola", "adeu", "adeu", "bye")
b <- as.factor(a)
as.character(b)
as.numeric(b)
str(b)
```
----

La función `factor` permite la codificación o recodificación manual de un vector. 
```{r, echo = TRUE}
a <- factor(c(3, 1, 3, 1, 1, 2), labels = c("adeu", "bye", "hola"))
a
levels(a)
```

## Datos compuestos -- *data frame*

```{r, echo = TRUE}
dfA <- data.frame(int = 1:10,
                  let = sample(letters, 10, replace = TRUE), 
                  ran = rnorm(10))
dfA
```
----

```{r, echo = TRUE}
dim(dfA) # Dimensión
nrow(dfA) # Número de columnas
ncol(dfA) # Número de filas
```

----

```{r, echo = TRUE}
str(dfA)
head(dfA, 3) # Primeros datos, 6 por defecto
tail(dfA, 2) # Últimos valores
```

----

Para acceder a los datos almacenados en el *data frame* se usan índices. Las variables de *data frame* también pueden extraerse usando su nombre.

```{r, echo = TRUE}
dfA[2,3]
dfA[,1]
dfA$let
```

Veremos más formas de acceder y usar los datos de una tabla de datos más adelante.

## Más datos compuestos -- lista
```{r, echo = TRUE}
a <- list(2, "2", FALSE)
b <- list(3, "hola", c(2, 3, 4))
```

<div style="column-count:2;">
```{r, echo = TRUE}
a
b
```
</div>

----

<div style="column-count:2;">
```{r, echo = TRUE}
length(a)
a[[3]]
b[[3]][1]
```

&nbsp;
<p style="display:block;break-after:column;"></p>

```{r, echo = TRUE}
str(b)
```

</div>

## Más datos compuestos -- factor ordenado
```{r, echo = TRUE}
notes <- c("Aprovat", "Insuficient", "Notable", "Insuficient",
           "Notable", "Excel·lent", "Aprovat")
notes <- factor(notes,
        levels = c("Insuficient", "Aprovat",
                   "Notable", "Excel·lent"),
        ordered = TRUE)
str(notes)
levels(notes)
```

## Más datos compuestos -- matriz
```{r, echo = TRUE}
a <- matrix(c(2, 4, -3, 5), ncol = 2)
a
a[2,2]
```

----
```{r, echo = TRUE}
a * a # Producto posición por posición
a %*% a # Producto matricial
t(a) # Transposición
```

## Instalación y carga de paquetes en R
R tiene muchos paquetes para resolver problemas específicos. Para usar un paquete adicional este debe instalarse y cargarse en memoria.

```{r, echo = TRUE, eval = FALSE}
installed.packages()[,1] # Lista los paquetes instalados
(.packages()) # Lista los paquetes en memoria
```

Dos recursos importantes para buscar y identificar paquetes relevantes son
https://www.rdocumentation.org/
https://cran.rstudio.com/web/views/

----

Para instalar un paquete, por ejemplo "nycflights13"
```{r, echo = TRUE, eval = FALSE}
install.packages("nycflights13")
```
Para cargar un paquete en memoria, se usa
```{r, echo = TRUE, eval = FALSE}
library("nycflights13")
```

En RStudio la gestión de paquetes también puede hacerse desde la interfaz del programa

----

En un script y para garantizar la disponibilidad de un paquete

```{r, echo = TRUE, eval = FALSE}
if(!require("nycflights13")) {
  install.packages("nycflights13")
  library("nycflights13")
}
```

----

Para acceder a la documentación de un paquete
```{r, echo = TRUE, eval = FALSE}
help(package="nycflights13")
```

Algunos paquetes tienen información adicional a la que se puede acceder con las funciones `vignette()` y `demo()`.


# Gráficos en R

## ¿Para qué usamos los gráficos?
La principales funciones de los gráficos en el análisis de datos son

- explorar los datos y facilitar su comprensión,
- permitir el descubrimiento de patrones no evidentes, y
- comunicar efectivamente los resultados de los análisis.


## Gráficos en R
Veremos dos paradigmas distintos para la creación de gráficos en R.

- Gráficos creados con el paquete `base`.
- Gráficos creados en base a la gramática de gráficos (*GoG*), usando el paquete `ggplot2`

## Gráficos en `base` R
Los gráficos en `base` R se construyen a partir de datos en vectores y usando funciones específicas en función del gráfico a realizar.

Para ejemplifiar algunas de estas funciones, usaremos el conjunto de datos `mtcars`, que forma de los paquetes básicos de R.

----

```{r, echo = TRUE}
str(mtcars)
```

----

```{r, echo = TRUE}
head(mtcars, 10)
```

----

Veremos como crear

- gráficos de dispersión,
- histogramas,
- diagramas de barras, y 
- diagramas de caja (*boxplot*)

## Gráficos en `base` R -- gráfico de dispersión
```{r, echo = TRUE, eval = FALSE}
plot(mtcars$disp,mtcars$hp)
```

----

```{r, echo = FALSE, eval = TRUE}
plot(mtcars$disp,mtcars$hp)
```

----

## Gráficos en `base` R -- histograma
```{r, echo = TRUE, eval = FALSE}
hist(mtcars$disp)
```

Añadiendo una curva de densidad...
```{r, echo = TRUE, eval = FALSE}
hist(mtcars$disp,breaks=20,freq=FALSE)
lines(density(mtcars$disp))
```

----

```{r, echo = FALSE, eval = TRUE}
hist(mtcars$disp)
```

----

```{r, echo = FALSE, eval = TRUE}
hist(mtcars$disp,breaks=20,freq=FALSE)
lines(density(mtcars$disp))
```

----

## Gráficos en `base` R -- diagrama de barras
```{r, echo = TRUE, eval = FALSE}
barplot(table(as.factor(mtcars$cyl)))
```

----

```{r, echo = FALSE, eval = TRUE}
barplot(table(as.factor(mtcars$cyl)))
```

## Gráficos en `base` R -- diagrama de caja
```{r, echo = TRUE, eval = FALSE}
boxplot(mtcars$disp)
points(mean(mtcars$disp))
```

----

```{r, echo = FALSE, eval = TRUE}
boxplot(mtcars$disp)
points(mean(mtcars$disp))
```

## Gramática de gráficos (*GoG*)
La **gramática de gráficos** es una aproximación teórica al estudio de los componentes de un gráfico. De acuerdo con este análisis, un gráfico se puede construir mediante la especificación de un conjunto de capas y componentes que definen los datos, la asociación de los mismos a aspectos del gráfico, la especificación de la relación entre los valores de las variables de los datos con las del gráfico, la estructura geométrica del gráfico...

<p class="bibref">Wilkinson, L. (2006). The grammar of graphics. Springer Science & Business Media.</p>

## `ggplot2`
`ggplot2` es un paquete de R que implementa de la gramática de gráficos.

<p class="bibref">Wickham, H. (2010). A layered grammar of graphics. *Journal of Computational and Graphical Statistics*, 19(1), 3-28.</p>

Referencias:

- http://ggplot2.tidyverse.org/reference/
- https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf
- http://www.ling.upenn.edu/~joseff/avml2012/
- http://r-statistics.co/Complete-Ggplot2-Tutorial-Part1-With-R-Code.html

----

`ggplot2` forma parte del paquete `tidyverse` (aunque también puede instalarse y cargarse autónomamente).
```{r, echo = TRUE, results = 'hide', message = FALSE, warning = FALSE, error = FALSE}
if(!require("tidyverse")) {
  install.packages("tidyverse")
  library("tidyverse")
}
```

## `ggplot2` -- capas y elementos del gráfico
En `ggplot2` cada elemento gráfico que representa un conjunto de datos constituye una capa. Una o más capas constituyen un gráfico.

Cada capa queda definida mediante la especificación de sus elementos. Los principales son 

- datos,
- mapeado estético, y
- geometrías

----

En `ggplot2`, los gráficos constituyen un objeto de R y se construyen de forma aditiva.

Por ejemplo,

```{r, echo = TRUE, eval = FALSE}
grafico <- ggplot(data = anscombe,
        mapping = aes(x = x1, y = y1))  # Datos y mapeado estético 
grafico <- grafico + geom_point()       # Geometría

grafico
```

----

```{r, echo = FALSE}
grafico <- ggplot(data = anscombe,
        mapping = aes(x = x1, y = y1))  # Datos y mapeado estético 
grafico <- grafico + geom_point()       # Geometría

grafico
```

## `ggplot2` -- datos
En `ggplot2`, el elemento `data` (datos) se introduce como primer argumento de la función `ggplot`. Debe corresponder a una tabla de datos o un tipo de datos convertible a tabla de datos.

```{r, echo = TRUE, eval = FALSE}
grafico <- ggplot(data = anscombe,
```

## `ggplot2` -- mapeado estético
El `mapping` (mapeado estético) corresponde al establecimiento de relaciones entre variables de los datos y variables del gráfico. Es el segundo argumento de la función `ggplot`y debe crearse con al función de apoyo `aes`. 

```{r, echo = TRUE, eval = FALSE}
        mapping = aes(x = x1, y = y1))
```

----

Para variables cuantitativas, los mapeados más comunes corresponden a

- posiciones: `x`, `y`...
- tamaño: `size`
- color: `color`, `fill`

----

Para variable cualitativas, los mapeados más frecuentes son

- posiciones: `x`, `y`...
- color: `color`, `fill`
- forma: `shape`


## `ggplot2` -- geometrías
Las geometrías (`geom_`) indican la forma que debe tener el gráfico, es decir, cómo se articulan las variables del gráfico. Se añaden al gráfico sumándose al objeto creado por `ggplot`.

```{r, echo = TRUE, eval = FALSE}
grafico <- grafico + geom_point()
```

----

Son geometrías de uso común

- `geom_point`
- `geom_line`, `geom_vline`, `geom_hline`
- `geom_bar`
- `geom_histogram`
- `geom_boxplot`

Un resumen de las geometrías y su relación con las variables del gráfico que reconoce cada una de ellas figura en  https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf.


## Gráficos en `ggplot2`


# Estadística básica con R


# Manipulación avanzada de tablas de datos

